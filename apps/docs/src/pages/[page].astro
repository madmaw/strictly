---
import fs from 'fs/promises'
import { marked } from 'marked'
import Layout from 'layouts/default.astro'
import { PageId } from 'components/mdx_navigation'
import { isDefined } from '@strictly/base'

// repurpose our README.md files as part of the main site
export async function getStaticPaths() {
  const packagesFolder = '../../packages'
  const packages = await fs.readdir(packagesFolder)
  return (await Promise.all(
    packages.map(async page => {
      const path = `${packagesFolder}/${page}/README.md`
      try {
        await fs.access(path)
        const buffer = await fs.readFile(path)
        const content = await marked.parse(buffer.toString())
        return {
          props: {
            content,
          },
          params: {
            page,
          }
        }
      } catch (_e) {
        // assume the file doesn't exist
        return
      }
    })
  )).filter(isDefined)
}

const { content } = Astro.props;
const { page } = Astro.params;

// create a fake frontmatter
const frontmatter = {
  page: page as PageId,
  url: Astro.url.toString(),
  file: page,
}
---
<Layout frontmatter={frontmatter} headings={[]} url={Astro.url.toString()}>
  <article set:html={content} />
</Layout>
